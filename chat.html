---
layout: default
title: Contact
permalink: /chat/
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Toggle</title>
  <style>
    .chat-container {
      position: fixed;
      right: 0px;
      bottom: 85px;
      max-height: 60vh;
      min-width: 200px;
      max-width: 300px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      overflow-y: auto;
      padding: 10px;
      z-index: 29;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: translateY(0);
    }

    .chat-container.hidden {
      display: none;
    }

    #openChatBtn {
      position: fixed;
      right: 10px;
      bottom: 20px;
      padding: 10px 16px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      z-index: 30;
    }
    

    

#message-input {
    padding: 10px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    font-size: 16px;
}




#messages {
    list-style: none;
    padding: 0;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
}

.grouped-message {
    background-color: #e0f7fa; /* Light blue background */
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex; /* Use flexbox for icon and text */
    align-items: center; /* Align items vertically */
}

.grouped-message:hover {
    background-color: #b2ebf2;
}

.grouped-message .message-icon {
    margin-right: 10px;
    font-size: 1.5em; /* Adjust icon size */
}

.grouped-message .message-count {
    font-weight: bold;
}

.chat-container {
    display: none; /* Initially hidden */
    padding: 10px;
    margin-left: 20px; /* Indent the chat container */
    border-left: 2px solid #ccc;
}

.chat-container li {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.chat-container li:last-child {
    border-bottom: none;
}


#message-input {
    display: none; /* Initially hide message input */
}


#messages li {
    margin-bottom: 10px; /* Add spacing between messages */
    padding: 5px;
    border-bottom: 1px solid #eee;
}

.message-account-id {
    font-weight: bold;
}

.message-text {
    margin-left: 20px; /* Indent the message text */
}

.message-date {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px; /* Add space between message and date */
    margin-left: 20px;
}

.reply-to-button {

    padding: 5px 10px;
    background-color: #06f;
    border: 1px solid #ccc;
    cursor: pointer;
}

.reply-to-button:hover {
    background-color: #07f;
}
  </style>
</head>
<body>

  <button id="openChatBtn">Open Chat</button>

  <div class="chat-container chat-container hidden" id="chatBox">



    <div id="message-modal" style="display: block;">
        <div id="messages-thread" style="display: block;">
            <ul id="messages"></ul>
        </div>
        <textarea id="message-input" placeholder="Type your message..." maxlength="480"></textarea>
<span id="message-char-count">480 characters remaining</span>
        <button id="send-message-btn">Send</button>
        <button id="close-modal-btn">Close</button>
    </div>
  <script>
    const openChatBtn = document.getElementById("openChatBtn");
    const chatBox = document.getElementById("chatBox");

    openChatBtn.addEventListener("click", () => {
      chatBox.classList.toggle("hidden");
    });










    document.addEventListener("DOMContentLoaded", async function () {
        await checkAuthStatus();
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
    
        fetch('data/categories.json')
            .then(response => response.json())
            .then(data => {
                let eventFound = false;
                for (const region in data.REGIONS) {
                    for (const province in data.REGIONS[region]) {
                        for (const city in data.REGIONS[region][province]) {
                            const categories = data.REGIONS[region][province][city].categories;
                            for (const category in categories) {
                                const events = categories[category];
                                const event = events.find(event => event.id === eventId);
                                if (event) {
                                    displayEventDetails(event);
                                    fetchMessageThread();
                                    eventFound = true;
                                    break;
                                }
                            }
                            if (eventFound) break;
                        }
                        if (eventFound) break;
                    }
                    if (eventFound) break;
                }
                if (!eventFound) {
                    document.getElementById('event-details').textContent = 'Event not found.';
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('event-details').textContent = 'Error loading event details.';
            });
    });
    
    function displayEventDetails(event) {
    document.getElementById('event-title').textContent = event.title;
    document.getElementById('event-location').innerHTML = `<strong>Location:</strong> ${event.location}`;
    document.getElementById('event-price').innerHTML = `<strong>Price:</strong> ${event.price}`;
    document.getElementById('event-date').innerHTML = `<strong>Date:</strong> ${event.date}`;
    document.getElementById('event-description').textContent = event.description;
    document.getElementById('account-id-display').innerHTML = `<strong>Submitted Via:</strong> ${event.accountId}`;
    const postDetails = document.getElementById('post-details');
    postDetails.dataset.posterId = event.accountId;
    postDetails.dataset.chatType = event.chatType; // Set chatType here
    checkUserPermissions(event.accountId);
    console.log("Poster id set to: " + event.accountId);
    console.log("Chat Type in displayEventDetails:", event.chatType);
    console.log("post-details element:", postDetails);
    console.log("post-details dataset:", postDetails.dataset);
    
        const mainImage = document.getElementById('main-image');
        mainImage.src = event.picture;
    
        const galleryContainer = document.getElementById('gallery-images');
        galleryContainer.innerHTML = '';
        if (event.images && Array.isArray(event.images)) {
            event.images.forEach(imageUrl => {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = event.title;
                img.onclick = function () {
                    mainImage.src = imageUrl;
                };
                galleryContainer.appendChild(img);
            });
        }
    
        document.getElementById('edit-title').value = event.title;
        document.getElementById('edit-location').value = event.location;
        document.getElementById('edit-date').value = event.date;
        document.getElementById('edit-description').value = event.description;
    
        let formattedPrice = event.price;
        if (formattedPrice) {
            formattedPrice = formattedPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    
        document.getElementById('edit-price').value = formattedPrice;
        document.getElementById('edit-title').dispatchEvent(new Event('input'));
        document.getElementById('edit-location').dispatchEvent(new Event('input'));
        document.getElementById('edit-description').dispatchEvent(new Event('input'));
    
        const previewContainer = document.getElementById("imagePreview");
        previewContainer.innerHTML = '';
        if (event.images && Array.isArray(event.images)) {
            event.images.forEach(imageUrl => {
                const previewItem = document.createElement("div");
                previewItem.className = "preview-item";
                const img = document.createElement("img");
                img.src = imageUrl;

                const removeButton = document.createElement("span");
                removeButton.textContent = "x";
                removeButton.className = "remove-button";
                removeButton.onclick = () => {
                    previewContainer.removeChild(previewItem);
                    updateFileInput(previewContainer);
                    removedImageUrls.push(imageUrl);
                };
                previewItem.appendChild(img);
                previewItem.appendChild(removeButton);
                previewContainer.appendChild(previewItem);
            });
        }
    }









    function getPostId() {
    const urlParams = new URLSearchParams(window.location.search);
    const idParam = urlParams.get('id');
    console.log('ID Parameter:', idParam);
    if (idParam) {
        return idParam;
    } else {
        console.error('Error: id parameter missing from URL.');
        return NaN;
    }
}

function getPosterId() {
    return document.getElementById('post-details').dataset.posterId;
}






function fetchMessageThread() {
    console.log("fetchMessageThread called. Account ID:", accountId, "Post ID:", getPostId());
    const postId = getPostId();
    const chatType = document.getElementById('post-details').dataset.chatType;
    console.log("Chat Type in fetchMessageThread: " + chatType);

    if (!postId || !accountId) {
        console.log("postId or accountId is missing.");
        return;
    }

    fetch(`http://localhost:3000/api/messages/${postId}/${accountId}?chatType=${chatType}`) // Add chatType as query parameter
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(messages => {
            console.log("Messages received:", messages);

            const messagesList = document.getElementById('messages');
            messagesList.innerHTML = '';

            if (chatType === 'standard') {
                createGroupElement(messages, messagesList);
            } else if (chatType === 'forum') {
                displayAllMessages(messages, messagesList);
            }

            const messageThreadModal = document.getElementById('messages-thread');
            console.log("Message Thread Modal Display (before):", messageThreadModal.style.display);
            messageThreadModal.style.display = 'block';
            console.log("Message Thread Modal Display (after):", messageThreadModal.style.display);
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
            alert('Failed to fetch messages.');
        });
}







function createGroupElement(group, parentElement) {
    if (!group || group.length === 0) {
        console.error("createGroupElement: Empty or invalid group.");
        return;
    }

    const conversationGroups = {};
    group.forEach(message => {
        const conversationId = message.conversationId;
        if (!conversationGroups[conversationId]) {
            conversationGroups[conversationId] = [];
        }
        conversationGroups[conversationId].push(message);
    });

    for (const conversationId in conversationGroups) {
        const conversationGroup = conversationGroups[conversationId];

        const groupElement = document.createElement('div');
        groupElement.className = 'grouped-message';
        groupElement.innerHTML = `<span class="message-icon">ðŸ’¬</span><span class="message-count">${conversationGroup.length} messages in conversation (${conversationId})</span>`;

        const chatContainer = document.createElement('ul');
        chatContainer.className = 'chat-container';
        chatContainer.dataset.conversationId = conversationId;
        chatContainer.style.display = 'none';

        conversationGroup.forEach(message => {
        const listItem = document.createElement('li');
        const accountIdElement = document.createElement('div');
        accountIdElement.className = 'message-account-id';
        accountIdElement.textContent = `(${message.senderId}):`;

        const messageTextElement = document.createElement('div');
        messageTextElement.className = 'message-text';
        messageTextElement.textContent = message.messageText;

        const messageDate = new Date(message.timestamp);
        const formattedDate = messageDate.toLocaleString();
        const dateElement = document.createElement('div');
        dateElement.className = 'message-date';
        dateElement.textContent = formattedDate;

        listItem.appendChild(accountIdElement);
        listItem.appendChild(messageTextElement);
        listItem.appendChild(dateElement);

        chatContainer.appendChild(listItem);
    });

        groupElement.addEventListener('click', (event) => {
            event.stopPropagation();

            document.querySelectorAll('.chat-container').forEach(otherChatContainer => {
                if (otherChatContainer !== chatContainer) {
                    otherChatContainer.style.display = 'none';
                }
            });

            const isChatVisible = chatContainer.style.display === 'block';
            chatContainer.style.display = isChatVisible ? 'none' : 'block';
            

            currentConversationId = conversationId;
            console.log("currentConversationId updated to:", currentConversationId);
            messageInput.style.display = isChatVisible ? 'none' : 'block';
            charCount.style.display = isChatVisible ? 'none' : 'block';
        });

        chatContainer.addEventListener('click', () => {
            if (conversationGroup.length > 0) {
                const lastMessage = conversationGroup[conversationGroup.length - 1];
                if (lastMessage.senderId !== accountId) {
                    messageInput.focus();
                } else {
                    messageInput.value = "";
                }
            }
        });

        if (currentConversationId === conversationId && messageInput.style.display === 'block') {
            chatContainer.style.display = 'block';
        }

        parentElement.appendChild(groupElement);
        parentElement.appendChild(chatContainer);
    }
}

function displayAllMessages(messages, parentElement) {
    messages.forEach(message => {
        const listItem = document.createElement('li');
        const accountIdElement = document.createElement('div');
        accountIdElement.className = 'message-account-id';
        accountIdElement.textContent = `(${message.senderId}):`;

        const messageTextElement = document.createElement('div');
        messageTextElement.className = 'message-text';
        messageTextElement.textContent = message.messageText;

        const messageDate = new Date(message.timestamp);
        const formattedDate = messageDate.toLocaleString();
        const dateElement = document.createElement('div');
        dateElement.className = 'message-date';
        dateElement.textContent = formattedDate;

        listItem.appendChild(accountIdElement);
        listItem.appendChild(messageTextElement);
        listItem.appendChild(dateElement);

        const replyButton = document.createElement('button');
        replyButton.textContent = 'Reply To';
        replyButton.className = 'reply-to-button';
        replyButton.dataset.senderId = message.senderId; // Store senderId

        replyButton.addEventListener('click', () => {
            const senderId = replyButton.dataset.senderId;
            messageInput.value = `@(${senderId}) `; // Add reference to senderId
            messageInput.focus();
        });

        listItem.appendChild(replyButton);
        parentElement.appendChild(listItem);
    });
}



contactSellerBtn.addEventListener('click', () => {
    console.log("Contact Seller button clicked.");

    if (!accountId) {
        alert("You must be logged in to contact.");
        return;
    }

    console.log("Contact Seller button clicked.");
    const postId = getPostId();
    const chatType = document.getElementById('post-details').dataset.chatType;

    if (chatType === 'forum') {
        currentConversationId = null;
    }

    fetch(`http://localhost:3000/api/messages/${postId}/${accountId}?chatType=${chatType}`)
        .then(response => response.json())
        .then(messages => {
            if (messages && messages.length > 0) {
                currentConversationId = messages[0].conversationId;
                const conversationMessages = messages.filter(msg => msg.conversationId === currentConversationId);
                const otherUserMessages = conversationMessages.filter(msg => msg.senderId !== accountId);
                if (otherUserMessages && otherUserMessages.length > 0) {
                    currentReceiverId = otherUserMessages[otherUserMessages.length - 1].senderId;
                } else {
                    currentReceiverId = getPosterId();
                }
            } else {
                currentReceiverId = getPosterId();
                currentConversationId = null;
            }

            console.log("Contact Seller button clicked. currentConversationId: " + currentConversationId);
            messageModal.style.display = 'block';

            messageInput.style.display = 'block';
            charCount.style.display = 'block';

            if (chatType === 'standard' && messages && messages.length > 0) {
                messageInput.style.display = 'none';
                charCount.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
            alert('An error occurred while fetching messages.');
        });
});





sendMessageBtn.addEventListener('click', () => {
    const messageText = messageInput.value;
    const postId = getPostId();
    const chatType = document.getElementById('post-details').dataset.chatType;

    if (messageText.length > maxChars) {
        alert(`Message cannot exceed ${maxChars} characters.`);
        return;
    }

    if (!accountId || !postId) {
        alert("Missing necessary data.");
        return;
    }

    sendMessageToServer(currentReceiverId, postId, messageText);

});

function sendMessageToServer(receiverId, postId, messageText) {
    if (!currentConversationId && document.getElementById('post-details').dataset.chatType === 'forum') {
        currentConversationId = Date.now().toString();
    }

    fetch('http://localhost:3000/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            senderId: accountId,
            receiverId: currentReceiverId, // Use currentReceiverId
            postId: postId,
            messageText: messageText,
            conversationId: currentConversationId,
        }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                messageInput.value = '';
                fetchMessageThread();

                if (!currentConversationId) {
                    currentConversationId = data.conversationId;
                }
            } else {
                console.error('Error sending message:', data.error);
                alert('Failed to send message. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('An error occurred. Please try again.');
        });
}



closeModalBtn.addEventListener('click', () => {
    messageModal.style.display = 'none';
});


let chatPollingInterval = null;

openChatBtn.addEventListener("click", () => {
  const isNowVisible = chatBox.classList.toggle("hidden");

  if (isNowVisible) {
    fetchMessageThread(); // Initial load
    chatPollingInterval = setInterval(fetchMessageThread, 10000); // Every 10 seconds
  } else {
    clearInterval(chatPollingInterval);
    chatPollingInterval = null;
  }
});

  </script>

</body>
</html>
