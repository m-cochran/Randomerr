---
layout: default
paginate: true
title: Result
---

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details</title>
    <style>

      
        /* Main image container */

        #event-title {
        font-size: 2.0em;
        font-weight: 600;
        color: #333;
        text-align: center;
        margin-bottom: 20px;
        text-transform: capitalize;
        letter-spacing: 1px;
    }  
        .main-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px; /* Space between main image and gallery */
       }
      
        .main-image-container img {
            width: 100%;         /* Full width of the container */
            max-width: 800px;    /* Limit the max width of the image */
            height: 400px;        /* Automatically adjust height to maintain aspect ratio */
            object-fit: contain; /* Fit image without cropping */
            border-radius: 8px;
            transition: transform 0.3s ease;
       }
        
        .event-details {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: auto;
        }

        .event-details img {
            max-width: 100%;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer; /* Add pointer cursor */
        }

        .event-details h1 {
            font-size: 2em;
            margin: 0 0 10px;
        }

        .event-details p {
            margin: 5px 0;
            color: #555;
        }

        .gallery-images {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            max-width: 600px;
            width: 100%;
            margin: 0 auto; 
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 40px;
        }

        .gallery-images img {
            width: 128px;
            height: 128px;
            object-fit: contain;
            border-radius: 5px;
            cursor: pointer; /* Add pointer cursor for gallery images */
            transition: transform 0.3s ease;
        }

        
        /* Scrollbar styling (optional) */
        .gallery-images::-webkit-scrollbar {
           height: 8px;
        }

        .gallery-images::-webkit-scrollbar-thumb {
           background-color: rgba(0, 0, 0, 0.3);
           border-radius: 4px;
        }

        /* Style for enlarged main image */
        .enlarged-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .enlarged-image img {
            max-width: 90%;
            max-height: 90%;
        }

        #account-id-display::before {
           content: '‚úÖ'; /* submitted-via */
           font-family: Arial, sans-serif;
           font-size: 16px;
           margin-right: 8px;
           color: #0066ff;
        }



        .event-info p.location::before {
           content: 'üìç'; /* Location pin */
           font-family: Arial, sans-serif;
           font-size: 16px;
           margin-right: 8px;
           color: #0066ff;
        }

        .event-info p.price::before {
          content: 'üí≤'; /* Dollar sign */
          font-family: Arial, sans-serif;
          font-size: 16px;
          margin-right: 8px;
          color: #28a745;
        }

        .event-info p.date::before {
          content: 'üìÖ'; /* Calendar */
          font-family: Arial, sans-serif;
          font-size: 16px;
          margin-right: 8px;
          color: #dc3545;
        }

        .event-info p strong {
          font-size: 16px;
         color: #555;
         display: inline;
         margin-bottom: 0px;
         margin-right: 5px;
        }

        .event-info {
        margin-top: 20px; /* Add space between image gallery and event info */
        max-width: 600px;
        margin: 20px auto; /* Center the event info */
        padding: 20px;
        background-color: #f9f9f9; /* Light background for the info section */
        border-radius: 8px;
        border: 1px solid #ddd;
        }

        .event-info p {
         margin: 15px 0;
         line-height: 1.7;
         color: #333;
         font-size: 16px;

        }

        #event-location-price, #event-date {
         display: block;
        }

        #event-description-container { /* New container for description */
         display: block;
         margin-top: 25px;
         text-align: center; /* Center the word "Description" */
        }

        #event-description-container strong { /* Style the "Description" word */
        display: block;
        font-size: 16px;
        color: #555;
        margin-bottom: 10px; /* Space between "Description" and content */
        }

        #event-description {
        display: block; /* Ensure description content is a block */
        text-align: left; /* Align description content to the left */
        white-space: pre-line;
        }

        .description {
        overflow-wrap: break-word;
        }

        #event-location-price, #event-date, #event-description{
        display: block; /* ensure these are block elements */
        }

        #account-id-display {
        font-size: 16px;
        color: #555;
        margin-top: 10px;
        /* Add any other desired styles */
        }



      .preview-item {
      position: relative;
      flex: 0 0 auto;
      width: 60px;
      height: 60px;
      cursor: move;
      }

      .preview-item.dragging {
    opacity: 0.5;
}


      .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      }
      .remove-button {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 0px 6px;
      cursor: pointer;
      font-size: 12px;
      }
      #uploadModal {
      max-width: 300px;
      width: 90%;
      margin: auto;
      display: flex; /* Use flexbox */
      flex-direction: column; /* Stack content vertically */
      }
      .modal-content {
      padding: 20px;
      border-radius: 5px;
      box-sizing: border-box;
      overflow-y: auto;
      max-height: 90vh;
      }

      #eventForm {
      flex-direction: column;
      width: 100%;
      }
      #imagePreview {
    display: flex;
    flex-wrap: nowrap;
    gap: 10px;
    overflow-x: auto;
    margin-top: 10px;
    max-width: 100%;
    padding: 10px 0;
    scrollbar-width: thin;
      }


      #event-description {
      white-space: pre-line;
      }

      textarea#description {
      min-width: 234px;
      max-width: 234px;
      min-height: 70px;
      }


      #edit-event-form {
      display: none; /* Initially hidden */
      max-width: 600px; /* Adjust as needed */
      margin: 20px auto; /* Center the form */
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      font-family: sans-serif;
      }

#edit-event-form h2 {
    text-align: center;
    margin-top: 0;
}

#edit-event-form label {
    font-weight: bold;
}




#titleChars,
#descriptionChars,
#locationChars {
display: block;
text-align: right;
margin-top: 0;
}

#edit-event-form textarea {
    padding: 10px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    font-size: 16px;
}

#edit-event-buttons {
    justify-content: center;
    text-align: center;
}



#send-message-btn,
#close-modal-btn,
#contact-seller-btn,
#edit-event-button,
#save-event-button,
#cancel-edit-button,
#delete-event-button {
  background-color: #0066ff; /* Green background */
  color: white; /* White text */
  padding: 10px 20px; /* Padding inside the button */
  font-size: 16px; /* Font size */
  border: none; /* Remove the default border */
  border-radius: 8px; /* Rounded corners */
  cursor: pointer; /* Pointer cursor on hover */
  transition: background-color 0.3s ease; /* Smooth transition for hover effect */
}












#message-input {
    padding: 10px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    font-size: 16px;
}




#messages {
    list-style: none;
    padding: 0;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
}

.grouped-message {
    background-color: #e0f7fa; /* Light blue background */
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex; /* Use flexbox for icon and text */
    align-items: center; /* Align items vertically */
}

.grouped-message:hover {
    background-color: #b2ebf2;
}

.grouped-message .message-icon {
    margin-right: 10px;
    font-size: 1.5em; /* Adjust icon size */
}

.grouped-message .message-count {
    font-weight: bold;
}

.chat-container {
    display: none; /* Initially hidden */
    padding: 10px;
    margin-left: 20px; /* Indent the chat container */
    border-left: 2px solid #ccc;
}

.chat-container li {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.chat-container li:last-child {
    border-bottom: none;
}


#message-input {
    display: none; /* Initially hide message input */
}


#messages li {
    margin-bottom: 10px; /* Add spacing between messages */
    padding: 5px;
    border-bottom: 1px solid #eee;
}

.message-account-id {
    font-weight: bold;
}

.message-text {
    margin-left: 20px; /* Indent the message text */
}

.message-date {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px; /* Add space between message and date */
    margin-left: 20px;
}

.reply-to-button {

    padding: 3px 3px;
    background-color: #06f;
    border: 1px solid #ccc;
    cursor: pointer;
    color: white;
    border-radius: 15px;
}

.reply-to-button:hover {
    background-color: #07f;
}

        
    </style>
</head>

<body>

  <div id="event-details">
    <h2 id="event-title"></h2>
    <div class="main-image-container">
        <img id="main-image" src="" alt="Main Event Image" onclick="enlargeImage(this)" />
    </div>
    <div class="gallery-images" id="gallery-images"></div>
</div>

<div class="enlarged-image" id="enlargedImage" onclick="this.style.display='none'">
    <img id="enlargedImageContent" src="" alt="Enlarged Image" />
</div>

<div class="event-info" id="event-info-container">
    <div id="event-location-price">
        <p id="account-id-display"></p>
        <p id="event-location" class="location"><strong>Location:</strong></p>
        <p id="event-price" class="price"><strong>Price:</strong></p>
    </div>
    <p id="event-date" class="date"><strong>Date:</strong></p>
    <button id="contact-seller-btn">Contact</button>
    <div id="message-modal" style="display: none;">
        <div id="messages-thread" style="display: none;">
            <ul id="messages"></ul>
        </div>
        <textarea id="message-input" placeholder="Type your message..." maxlength="480"></textarea>
<span id="message-char-count">480 characters remaining</span>
        <button id="send-message-btn">Send</button>
        <button id="close-modal-btn">Close</button>
    </div>
    

    
    <div id="post-details" data-poster-id="2"></div>
    <div id="event-description-container">
        <strong>Description</strong>
        <p id="event-description" class="description"></p>
    </div>
    <div class="display-controls" id="display-controls">
        <button id="edit-event-button" style="display: none;">Edit Event</button>
    </div>
</div>






<div id="edit-event-form" style="display: none;">
  <h2>Edit Event</h2>
  <div>
  <label for="edit-title">Title:</label>
  <input type="text" id="edit-title" name="title" placeholder="Event Title (Max 62 characters)" maxlength="62" required />
  <span id="titleChars">62 characters remaining</span>
</div>
<div>
  <label for="edit-description">Description:</label><br>
  <textarea id="edit-description" name="description" placeholder="Event Description (Max 3000 characters)" maxlength="3000" required></textarea>
  <span id="descriptionChars">3000 characters remaining</span>
</div>
<div>
  <label for="edit-date">Date:</label>
  <input type="date" id="edit-date" name="date" required />
</div>
<div>
  <label for="edit-location">Location: </label>
  <input type="text" id="edit-location" name="location" placeholder="Event Location (Max 45 characters)" maxlength="45" required />
  <span id="locationChars">45 characters remaining</span>
</div>
<div>
  <label for="edit-price">Price:</label>
  <input type="text" id="edit-price" name="price" placeholder="Enter price"/>
</div>
<div>
  <label for="images">Upload (Max 16 Images)</label>
  <input type="file" id="images" name="images" multiple accept=".png, .jpg, .jpeg"><br><br>
  <div id="imagePreview"></div><br>
</div>

  <input type="hidden" id="removedImages" name="removedImages">
<div id="edit-event-buttons">
  <button id="save-event-button">Save</button>
  <button id="cancel-edit-button">Cancel</button>
  <button id="delete-event-button">Delete</button>
  <div>
</div>


<script>
// =========================================================================
// Global Variables and DOM Element Initialization
// =========================================================================

let loggedInUserData = null;
let removedImageUrls = [];



const maxImages = 16;
// selectedFiles will hold:
// - For existing images: plain objects with { isExisting: true, originalUrl: "full_path", _preview: "full_path" }
// - For new images: actual File objects with { isExisting: false, _preview: "blob:..." }
let selectedFiles = [];
const fileInput = document.getElementById("images");
const previewContainer = document.getElementById("imagePreview");

// Define allowed file types and max size (consistent with backend)
const allowedMimeTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/avif', 'image/gif'];
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes

// Helper to update the hidden file input. Only new files are added here.
function updateFileInput() {
    const dataTransfer = new DataTransfer();
    selectedFiles.filter(file => !file.isExisting).forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
    console.log("updateFileInput: Current files in hidden input (new only):", fileInput.files);
}



// =========================================================================
// Authentication and Authorization Functions
// =========================================================================

function checkUserPermissions(eventAccountId) {
    const editButton = document.getElementById('edit-event-button');
    if (loggedInUserData && loggedInUserData.loggedIn && loggedInUserData.accountId) {
        if (loggedInUserData.accountId === eventAccountId) {
            editButton.style.display = 'block';
        } else {
            editButton.style.display = 'none';
        }
    } else {
        editButton.style.display = 'none';
    }
}

// =========================================================================
// Event Details Display and Data Loading Functions
// =========================================================================

document.addEventListener("DOMContentLoaded", async function () {
    await checkAuthStatus(); // Ensure this function is defined elsewhere
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    fetch('data/categories.json')
        .then(response => response.json())
        .then(data => {
            let eventFound = false;
            for (const region in data.REGIONS) {
                for (const province in data.REGIONS[region]) {
                    for (const city in data.REGIONS[region][province]) {
                        const categories = data.REGIONS[region][province][city].categories;
                        for (const category in categories) {
                            const events = categories[category];
                            const event = events.find(event => event.id === eventId);
                            if (event) {
                                displayEventDetails(event);
                                // fetchMessageThread(); // Assuming this function is defined elsewhere
                                eventFound = true;
                                break;
                            }
                        }
                        if (eventFound) break;
                    }
                    if (eventFound) break;
                }
                if (eventFound) break;
            }
            if (!eventFound) {
                document.getElementById('event-details').textContent = 'Event not found.';
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('event-details').textContent = 'Error loading event details.';
        });
});

function displayEventDetails(event) {
    document.getElementById('event-title').textContent = event.title;
    document.getElementById('event-location').innerHTML = `<strong>Location:</strong> ${event.location}`;
    document.getElementById('event-price').innerHTML = `<strong>Price:</strong> ${event.price}`;
    document.getElementById('event-date').innerHTML = `<strong>Date:</strong> ${event.date}`;
    document.getElementById('event-description').textContent = event.description;
    document.getElementById('account-id-display').innerHTML = `<strong>Submitted Via:</strong> ${event.accountId}`;
    const postDetails = document.getElementById('post-details');
    postDetails.dataset.posterId = event.accountId;
    postDetails.dataset.chatType = event.chatType; // Set chatType here
    checkUserPermissions(event.accountId);
    console.log("Poster id set to: " + event.accountId);
    console.log("Chat Type in displayEventDetails:", event.chatType);
    console.log("post-details element:", postDetails);
    console.log("post-details dataset:", postDetails.dataset);

    const mainImage = document.getElementById('main-image');
    mainImage.src = event.picture;

    const galleryContainer = document.getElementById('gallery-images');
    galleryContainer.innerHTML = '';
    if (event.images && Array.isArray(event.images)) {
        event.images.forEach(imageUrl => {
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = event.title;
            img.onclick = function () {
                mainImage.src = imageUrl;
            };
            galleryContainer.appendChild(img);
        });
    }

    document.getElementById('edit-title').value = event.title;
    document.getElementById('edit-location').value = event.location;
    document.getElementById('edit-date').value = event.date;
    document.getElementById('edit-description').value = event.description;

    let formattedPrice = event.price;
    if (formattedPrice) {
        formattedPrice = formattedPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    document.getElementById('edit-price').value = formattedPrice;
    document.getElementById('edit-title').dispatchEvent(new Event('input'));
    document.getElementById('edit-location').dispatchEvent(new Event('input'));
    document.getElementById('edit-description').dispatchEvent(new Event('input'));

    previewContainer.innerHTML = '';
    removedImageUrls = []; // Clear removed images on fresh load

    // Reset selectedFiles when loading for edit
    selectedFiles = []; // <--- IMPORTANT: Clear any previous selections
    if (event.images && Array.isArray(event.images)) {
        event.images.forEach(imageUrl => {
            const previewItem = document.createElement("div");
            previewItem.className = "preview-item";
            const img = document.createElement("img");
            img.src = imageUrl;

            // Create a plain object for existing images with necessary properties
            const dummyFile = {
                // Generate a unique ID for this dummy object, not necessarily a file name
                id: `existing-${Date.now()}-${Math.random()}`,
                isExisting: true, // Flag to identify it as an existing image
                originalUrl: imageUrl, // THIS MUST BE THE FULL, CORRECT PATH (e.g., /uploads/image.webp)
                _preview: imageUrl // This will be the img.src, used for lookup during reorder
            };

            selectedFiles.push(dummyFile); // Add existing dummy image to selectedFiles

            const removeButton = document.createElement("span");
            removeButton.textContent = "√ó";
            removeButton.className = "remove-button";
            removeButton.onclick = () => {
                previewContainer.removeChild(previewItem);
                // Remove from selectedFiles based on the dummyFile object itself
                const index = selectedFiles.indexOf(dummyFile);
                if (index > -1) selectedFiles.splice(index, 1);

                updateFileInput(); // Update the hidden file input (only affects new files)
                removedImageUrls.push(imageUrl); // Push the actual original URL to be removed
                console.log("Removed Image URLs:", removedImageUrls);
            };
            previewItem.appendChild(img);
            previewItem.appendChild(removeButton);
            previewContainer.appendChild(previewItem);

            previewItem.setAttribute("draggable", "true");

            previewItem.addEventListener("dragstart", () => {
                previewItem.classList.add("dragging");
            });

            previewItem.addEventListener("dragend", () => {
                previewItem.classList.remove("dragging");
                reorderSelectedFiles(); // <-- Important to update selectedFiles order
            });
        });
    }
    console.log("displayEventDetails: Initial selectedFiles (includes existing):", selectedFiles);
    updateFileInput(); // Update the file input based on initial selectedFiles (will be empty if only existing)
}

// =========================================================================
// Image Handling and Preview Functions
// =========================================================================

fileInput.addEventListener("change", handleImageUpload);

function handleImageUpload(event) {
    const files = Array.from(event.target.files);

    if (files.length === 0) {
        event.target.value = ''; // Clear file input if no files selected
        return;
    }

    const filesToAdd = [];
    for (const file of files) {
        // Check if adding this file would exceed the total image limit (existing + new)
        if ((selectedFiles.length + filesToAdd.length) >= maxImages) {
            alert(`You can only have a total of ${maxImages} images. No more files will be added.`);
            break; // Stop processing further files
        }

        // Client-side validation for file type
        if (!allowedMimeTypes.includes(file.type)) {
            alert(`File "${file.name}" is an invalid type. Only JPEG, PNG, WebP, AVIF, and GIF are allowed.`);
            continue; // Skip this file
        }

        // Client-side validation for file size
        if (file.size > MAX_FILE_SIZE) {
            alert(`File "${file.name}" is too large. Maximum allowed size is ${MAX_FILE_SIZE / (1024 * 1024)}MB.`);
            continue; // Skip this file
        }

        // Assign a temporary preview URL for new files and mark as new
        file._preview = URL.createObjectURL(file); // Data URL for preview
        file.isExisting = false; // Explicitly mark as a new file (actual File object)
        filesToAdd.push(file);
    }

    if (filesToAdd.length === 0) {
        event.target.value = ""; // Clear the file input if no valid files were selected
        updateFileInput();
        return;
    }

    filesToAdd.forEach(file => {
        const previewItem = document.createElement("div");
        previewItem.className = "preview-item";

        const img = document.createElement("img");
        img.src = file._preview; // Use the stored preview URL

        const removeBtn = document.createElement("span");
        removeBtn.className = "remove-button";
        removeBtn.textContent = "√ó";
        removeBtn.onclick = () => {
            const index = selectedFiles.indexOf(file); // Find the actual File object
            if (index > -1) selectedFiles.splice(index, 1);
            previewContainer.removeChild(previewItem);
            URL.revokeObjectURL(file._preview); // Clean up the object URL for new files
            updateFileInput(); // Call to reflect changes in file input
        };

        previewItem.appendChild(img);
        previewItem.appendChild(removeBtn);
        previewContainer.appendChild(previewItem);

        previewItem.setAttribute("draggable", "true");

        previewItem.addEventListener("dragstart", () => {
            previewItem.classList.add("dragging");
        });

        previewItem.addEventListener("dragend", () => {
            previewItem.classList.remove("dragging");
            reorderSelectedFiles(); // <-- Important to update selectedFiles order
        });

        selectedFiles.push(file); // Add the validated actual File object to selectedFiles
    });

    event.target.value = ""; // Clear the input field after files are processed
    console.log("handleImageUpload: selectedFiles after adding new:", selectedFiles);
    updateFileInput(); // Update the hidden file input with relevant files
}

function reorderSelectedFiles() {
    const newOrder = [];
    const imageElements = previewContainer.querySelectorAll('.preview-item img');

    imageElements.forEach(img => {
        const src = img.src; // This will be the full URL for existing, or blob: URL for new.

        // Extract filename for existing images (assuming backend uses unique filenames)
        const srcFilename = src.substring(src.lastIndexOf('/') + 1);

        const match = selectedFiles.find(file => {
            if (file.isExisting) {
                // For existing files, compare filenames
                const fileFilename = file.originalUrl.substring(file.originalUrl.lastIndexOf('/') + 1);
                return fileFilename === srcFilename;
            } else {
                // For new files, compare the full blob: URL
                return file._preview === src;
            }
        });

        if (match) {
            newOrder.push(match);
        } else {
            console.warn("reorderSelectedFiles: Could not find a matching file for image src:", src);
            console.log("Current selectedFiles for debugging (checking _preview/originalUrl):", selectedFiles.map(f => f.isExisting ? f.originalUrl : f._preview));
        }
    });

    selectedFiles = newOrder;
    console.log("reorderSelectedFiles: updated selectedFiles order:", selectedFiles);
    updateFileInput();
}

previewContainer.addEventListener("dragover", (e) => {
    e.preventDefault();
    const afterElement = getDragAfterElement(previewContainer, e.clientX);
    const draggingItem = document.querySelector(".dragging");
    if (!draggingItem) return;
    if (afterElement == null) {
        previewContainer.appendChild(draggingItem);
    } else {
        previewContainer.insertBefore(draggingItem, afterElement);
    }
});

function getDragAfterElement(container, x) {
    const elements = [...container.querySelectorAll(".preview-item:not(.dragging)")];

    return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - (box.left + box.width / 2);
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// =========================================================================
// Editing and Saving Event Data
// =========================================================================

document.getElementById('edit-event-button').addEventListener('click', function () {
    document.getElementById('event-details').style.display = 'none';
    document.getElementById('event-info-container').style.display = 'none';
    document.getElementById('edit-event-form').style.display = 'block';
});

document.getElementById('cancel-edit-button').addEventListener('click', function () {
    document.getElementById('event-details').style.display = 'block';
    document.getElementById('event-info-container').style.display = 'block';
    document.getElementById('edit-event-form').style.display = 'none';
});

function updateCharCount(inputId, countId, maxChars) {
    const inputElement = document.getElementById(inputId);
    const countElement = document.getElementById(countId);

    if (inputElement) {
        if (inputElement.value.length > maxChars) {
            inputElement.value = inputElement.value.slice(0, maxChars);
        }
        const initialRemainingChars = maxChars - inputElement.value.length;
        countElement.textContent = initialRemainingChars + ' characters remaining';
    }

    if (inputElement) {
        inputElement.addEventListener('input', function () {
            if (this.value.length > maxChars) {
                this.value = this.value.slice(0, maxChars);
            }
            const remainingChars = maxChars - this.value.length;
            countElement.textContent = remainingChars + ' characters remaining';
        });
    }
}

updateCharCount('edit-title', 'titleChars', 62);
updateCharCount('edit-description', 'descriptionChars', 3000);
updateCharCount('edit-location', 'locationChars', 45);

document.getElementById('edit-price').addEventListener('input', function (event) {
    let value = this.value.replace(/[^0-9.]/g, '');
    let parts = value.split('.');
    let integerPart = parts[0] || '';
    let decimalPart = parts[1] || '';

    if (integerPart.length > 9) {
        integerPart = integerPart.slice(0, 9);
    }

    if (decimalPart && decimalPart.length > 2) {
        decimalPart = decimalPart.slice(0, 2);
    }

    if (integerPart === '999999999' && decimalPart && decimalPart.length > 0) {
        decimalPart = "";
    }

    if (integerPart.length > 0) {
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    if (decimalPart) {
        this.value = integerPart + '.' + decimalPart;
    } else {
        this.value = integerPart;
    }
});

document.getElementById("save-event-button").addEventListener("click", async function (e) {
    e.preventDefault();

    reorderSelectedFiles(); // Ensure files are in correct order before uploading

    const eventId = new URLSearchParams(window.location.search).get('id');
    const formData = new FormData();
    formData.append('title', document.getElementById('edit-title').value);
    formData.append('location', document.getElementById('edit-location').value);
    formData.append('description', document.getElementById('edit-description').value);
    formData.append('date', document.getElementById('edit-date').value);

    // Only append NEW files (those not marked as isExisting) to the 'images' field for upload
    selectedFiles.filter(file => !file.isExisting).forEach(file => {
        formData.append('images', file); // These are actual File objects from new uploads
    });

    const priceInput = document.getElementById('edit-price');
    let priceValue = priceInput.value.replace(/,/g, '');

    let parts = priceValue.split('.');
    let integerPart = parts[0] || '';
    let decimalPart = parts[1] || '';

    if (integerPart.length > 9 || (decimalPart && decimalPart.length > 2) || (integerPart && !/^\d+$/.test(integerPart)) || (decimalPart && !/^\d+$/.test(decimalPart))) {
        alert('Price must contain only numeral digits with a maximum of 9 digits before and 2 digits after the decimal point.');
        priceInput.focus();
        return;
    }

    if (integerPart === '999999999' && decimalPart && decimalPart.length > 0) {
        alert('Maximum price allowed is 999,999,999. No decimal allowed at maximum value.');
        priceInput.focus();
        return;
    }

    if (priceValue === '0' || priceValue === '0.0' || priceValue === '0.00') {
        priceInput.value = '0.00';
    }

    formData.append('price', priceInput.value.replace(/,/g, ''));
    formData.append('removedImages', JSON.stringify(removedImageUrls));

    // Collect the URLs of existing images that are still in `selectedFiles`
    // This is the ordered list of URLs to KEEP on the backend.
    const currentExistingImageUrls = selectedFiles
        .filter(file => file.isExisting) // Get only the existing image "dummy" objects
        .map(file => file.originalUrl); // CRITICAL: Extract their original server URLs

    formData.append('currentExistingImages', JSON.stringify(currentExistingImageUrls));

    // --- FINAL INSPECTION BEFORE SENDING ---
    console.log("--- Sending FormData to Backend ---");
    for (let [key, value] of formData.entries()) {
        if (key === 'currentExistingImages' || key === 'removedImages') {
            console.log(`${key}:`, JSON.parse(value));
        } else if (key === 'images') {
            // For File objects, log name and size
            console.log(`${key}:`, value.name, value.size, value.type);
        } else {
            console.log(`${key}:`, value);
        }
    }
    // debugger; // Uncomment to pause here and verify formData just before fetch
    console.log("--- End FormData Inspection ---");
    // --- END FINAL INSPECTION ---

    try {
        const response = await fetch(`http://localhost:3000/update-event/${eventId}`, {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });

        const data = await response.json();
        if (response.ok) { // Check response.ok for successful HTTP status codes (200-299)
            alert(data.message);
            window.location.reload();
        } else {
            alert(`Error: ${data.error || 'Failed to update event.'}`);
            console.error('Backend Error Response:', data); // Log the full error response
        }
    } catch (error) {
        console.error('Network or Unhandled Error updating event:', error);
        alert('An error occurred while updating the event. Please check console for details.');
    }
});


previewContainer.addEventListener("dragover", (e) => {
    e.preventDefault();
    const afterElement = getDragAfterElement(previewContainer, e.clientX);
    const draggingItem = document.querySelector(".dragging");
    if (!draggingItem) return;
    if (afterElement == null) {
        previewContainer.appendChild(draggingItem);
    } else {
        previewContainer.insertBefore(draggingItem, afterElement);
    }
});

function getDragAfterElement(container, x) {
    const elements = [...container.querySelectorAll(".preview-item:not(.dragging)")];

    return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - (box.left + box.width / 2);
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// =========================================================================
// Event Deletion
// =========================================================================

document.addEventListener("DOMContentLoaded", function() {
    const deleteButton = document.getElementById('delete-event-button');
    if (deleteButton) {
        deleteButton.addEventListener('click', function() {
            if (confirm("Are you sure you want to delete this event?")) {
                if (confirm("Are you absolutely sure you want to delete this event? This action cannot be undone.")) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const eventId = urlParams.get('id');

                    fetch(`http://localhost:3000/delete-event/${eventId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert(data.message);
                            window.location.href = "/";
                        } else if (data.error) {
                            alert(data.error);
                        } else {
                            alert('Failed to delete event.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting event:', error);
                        alert('An error occurred while deleting the event.');
                    });
                }
            }
        });
    } else {
        console.error("Delete button not found.");
    }
});
// =========================================================================
// Message Thread and Communication Functions
// =========================================================================


// =========================================================================
// Image Enlargement Functionality
// =========================================================================

function enlargeImage(img) {
    const enlargedImageDiv = document.getElementById('enlargedImage');
    const enlargedImageContent = document.getElementById('enlargedImageContent');
    enlargedImageContent.src = img.src;
    enlargedImageDiv.style.display = 'flex';
}

// =========================================================================
// Additional DOM Event Listeners
// =========================================================================



















let accountId = null; // Set on login
let currentConversationId = null;
let currentReceiverId = null;

const contactSellerBtn = document.getElementById('contact-seller-btn');
const messageModal = document.getElementById('message-modal');
const sendMessageBtn = document.getElementById('send-message-btn');
const closeModalBtn = document.getElementById('close-modal-btn');
const messageInput = document.getElementById('message-input');
const messagesList = document.getElementById('messages');
const charCount = document.getElementById('message-char-count');
const maxChars = 480;

// --- Character counter ---
if (messageInput && charCount) {
  messageInput.addEventListener('input', () => {
    charCount.textContent = `${maxChars - messageInput.value.length} characters remaining`;
  });
}

// --- Helpers ---
function getPostId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id') || null;
}

function getPosterId() {
  const elem = document.getElementById('post-details');
  return elem ? elem.dataset.posterId : null;
}

// --- Fetch per-user message thread ---
function fetchMessageThread() {
  const postId = getPostId();
  const chatType = document.getElementById('post-details').dataset.chatType;
  if (!postId || !accountId) return;

  fetch(`http://localhost:3000/api/messages/${postId}/${accountId}?chatType=${chatType}`)
    .then(res => res.json())
    .then(messages => {
      messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      messagesList.innerHTML = '';

      if (chatType === 'standard') {
        const openConversation = currentConversationId; // remember which conversation was open

        if (messages.length > 0) {
          currentConversationId = messages[0].conversationId;
          const otherMsgs = messages.filter(m => m.senderId !== accountId);
          currentReceiverId = otherMsgs.length ? otherMsgs[otherMsgs.length - 1].senderId : getPosterId();
        } else {
          currentConversationId = null;
          currentReceiverId = getPosterId();
        }

        createGroupElement(messages, messagesList);

        // Restore open conversation if any
        if (openConversation) {
          const chatContainer = document.querySelector(`.chat-container[data-conversation-id="${openConversation}"]`);
          if (chatContainer) {
            chatContainer.style.display = 'block';
            currentConversationId = openConversation;
            sendMessageBtn.style.display = 'inline-block';
            messageInput.style.display = 'block';
            charCount.style.display = 'block';
          }
        }
      } else {
        displayAllMessages(messages, messagesList);
      }

      document.getElementById('messages-thread').style.display = 'block';
    })
    .catch(err => console.error('Error fetching messages:', err));
}





// --- Group messages for standard chat ---
function createGroupElement(messages, parent) {
  const groups = {};
  messages.forEach(msg => {
    if (!groups[msg.conversationId]) groups[msg.conversationId] = [];
    groups[msg.conversationId].push(msg);
  });

  Object.keys(groups).forEach(conversationId => {
    const convMsgs = groups[conversationId];

    const groupElem = document.createElement('div');
    groupElem.className = 'grouped-message';
    groupElem.innerHTML = `<span class="message-icon">üí¨</span>
      <span class="message-count">${convMsgs.length} messages (ID: ${conversationId})</span>`;

    const chatContainer = document.createElement('ul');
    chatContainer.className = 'chat-container';
    chatContainer.dataset.conversationId = conversationId;
    chatContainer.style.display = 'none';

    convMsgs.forEach(msg => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="message-account-id">(${msg.senderId}):</div>
        <div class="message-text">${msg.messageText}</div>
        <div class="message-date">${new Date(msg.timestamp).toLocaleString()}</div>
      `;
      chatContainer.appendChild(li);
    });

    groupElem.addEventListener('click', () => {
      const isVisible = chatContainer.style.display === 'block';
      document.querySelectorAll('.chat-container').forEach(c => c.style.display = 'none');
      chatContainer.style.display = isVisible ? 'none' : 'block';
      sendMessageBtn.style.display = isVisible ? 'none' : 'inline-block';
      messageInput.style.display = isVisible ? 'none' : 'block';
      charCount.style.display = isVisible ? 'none' : 'block';
      currentConversationId = isVisible ? null : conversationId;
    });

    parent.appendChild(groupElem);
    parent.appendChild(chatContainer);
  });
}

// --- Forum messages ---
function displayAllMessages(messages, parent) {
  messages.forEach(msg => {
    const li = document.createElement('li');
    li.innerHTML = `
      <div class="message-account-id">(${msg.senderId}):</div>
      <div class="message-text">${msg.messageText}</div>
      <div class="message-date">${new Date(msg.timestamp).toLocaleString()}</div>
    `;

    const replyBtn = document.createElement('button');
    replyBtn.textContent = 'Reply';
    replyBtn.className = 'reply-to-button';
    replyBtn.dataset.senderId = msg.senderId;
    replyBtn.addEventListener('click', () => {
      messageInput.value = `@(${msg.senderId}) `;
      messageInput.focus();
    });

    li.appendChild(replyBtn);
    parent.appendChild(li);
  });
}

// --- Send message ---
sendMessageBtn.addEventListener('click', async () => {
  const messageText = messageInput.value.trim();
  const postId = getPostId();
  const chatType = document.getElementById('post-details').dataset.chatType;
  const eventOwnerId = getPosterId(); // forum messages go to the event owner folder

  if (!messageText) return;
  if (messageText.length > maxChars) { alert(`Max ${maxChars} chars.`); return; }
  if (!accountId || !postId) { alert("Missing data."); return; }

  if (!currentConversationId && chatType !== 'forum') currentConversationId = Date.now().toString();

  try {
    if (chatType === 'forum') {
      // Forum message endpoint
      const res = await fetch('http://localhost:3000/api/forum-messages/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          senderId: accountId,
          eventOwnerId,
          eventId: postId,
          messageText
        })
      });
      const data = await res.json();
      if (data.success) {
        messageInput.value = '';
        fetchForumMessages(postId, eventOwnerId);
      } else alert(data.error || 'Failed to send forum message.');
    } else {
      // Standard chat
      const res = await fetch('http://localhost:3000/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          senderId: accountId,
          receiverId: currentReceiverId,
          postId,
          messageText,
          conversationId: currentConversationId,
          chatType
        })
      });
      const data = await res.json();
      if (data.message) {
        messageInput.value = '';
        if (!currentConversationId) currentConversationId = data.conversationId;
        fetchMessageThread();
      } else alert(data.error || 'Failed to send message.');
    }
  } catch (err) {
    console.error(err);
  }
});

// --- Fetch forum messages ---
async function fetchForumMessages(postId, eventOwnerId) {
  messagesList.innerHTML = '<li>Loading forum messages...</li>';
  try {
    const res = await fetch(`http://localhost:3000/api/forum-messages/${eventOwnerId}/${postId}`);
    const messages = await res.json();
    messagesList.innerHTML = '';
    displayForumMessages(messages);
    document.getElementById('messages-thread').style.display = 'block';
  } catch (err) {
    console.error('Failed to load forum messages', err);
    messagesList.innerHTML = '<li>Error loading forum messages</li>';
  }
}


// --- Display forum messages ---
function displayForumMessages(messages) {
  messagesList.innerHTML = '';
  messages.forEach(msg => {
    const li = document.createElement('li');
    li.innerHTML = `
      <div class="message-account-id">(${msg.senderId}):</div>
      <div class="message-text">${msg.messageText}</div>
      <div class="message-date">${new Date(msg.timestamp).toLocaleString()}</div>
    `;
    const replyBtn = document.createElement('button');
    replyBtn.textContent = 'Reply';
    replyBtn.className = 'reply-to-button';
    replyBtn.addEventListener('click', () => {
      messageInput.value = `@${msg.senderId} `;
      messageInput.focus();
    });
    li.appendChild(replyBtn);
    messagesList.appendChild(li);
  });
}





// --- Open modal ---
contactSellerBtn.addEventListener('click', async () => {
  if (!accountId) { alert("You must be logged in."); return; }

  const postId = getPostId();
  const chatType = document.getElementById('post-details').dataset.chatType;
  const isAuthor = accountId === getPosterId();

  messageModal.style.display = 'block';
  messageInput.style.display = isAuthor ? 'none' : 'block';
  charCount.style.display = isAuthor ? 'none' : 'block';
  sendMessageBtn.style.display = isAuthor ? 'none' : 'inline-block';

  if (chatType === 'forum') {
    await fetchForumMessages(postId, getPosterId());
  } else {
    // --- STANDARD CHAT: fetch messages and set currentReceiverId ---
    try {
      const res = await fetch(`http://localhost:3000/api/messages/${postId}/${accountId}?chatType=${chatType}`);
      const messages = await res.json();

      if (messages.length > 0) {
        currentConversationId = messages[0].conversationId;
        const otherMsgs = messages.filter(m => m.senderId !== accountId);
        currentReceiverId = otherMsgs.length ? otherMsgs[otherMsgs.length - 1].senderId : getPosterId();
      } else {
        currentConversationId = null;
        currentReceiverId = getPosterId();
      }

      fetchMessageThread(); // display messages
    } catch (err) {
      console.error('Failed to load standard chat messages', err);
    }
  }
});



// --- Close modal ---
closeModalBtn.addEventListener('click', () => { messageModal.style.display = 'none'; });





</script>



</body>

</html>
